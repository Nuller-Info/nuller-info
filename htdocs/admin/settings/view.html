<h1>{{event.rankings[0].title}} – Einstellungen</h1>
<form name="form" ng-keydown="keydown($event)">
  <fieldset style="display:inline">
    <legend>Allgemein</legend>
    <table>
      <tr ng-if="!event.id && events.length">
	<th><label for="title">Basierend auf</label></th>
	<td>
	  <select ng-model="event.base" ng-options="event.tag as event_name(event) for event in events | filter:event_visible">
	    <option value=""></option>
	  </select>
	</td>
      </tr>
      <tr ng-if="!event.id && internal.base && future_events.length">
	<th><label for="title">Veranstaltung</label></th>
	<td>
	  <select ng-model="event.base_fid" ng-options="fe.fid as fe.title for fe in future_events">
	    <option value=""></option>
	  </select>
	</td>
      </tr>
      <tr ng-if="!event.id && internal.base">
	<th><label for="title">Zurücksetzen auf</label></th>
	<td>
	  <select ng-model="internal.reset" ng-disabled="event.base_fid != null">
	    <option value=""></option>
	    <option value="start">Start</option>
	    <option value="register">Nennbeginn</option>
	    <option value="master">Nur Stammdaten</option>
	  </select>
	  <span ng-if="internal.base.starters[event.base_fid] && future_event_active(event.base_fid)" style="color:green">
	    {{internal.base.starters[event.base_fid]}} Fahrer schon als Starter markiert.
	  </span>
	</td>
      </tr>
      <tr>
	<th><label for="title">Titel</label></th>
	<td><input type="text" size="40" maxlength="70" ng-model="event.rankings[0].title" id="title" name="title" nullable></td>
      </tr>
      <tr>
	<th><label for="subtitle">Subtitel</label></th>
	<td><input type="text" size="40" maxlength="70" ng-model="event.rankings[0].subtitle" id="subtitle nullable"></td>
      </tr>
      <tr>
	<th><label for="date">Datum</label></th>
	<td><input type="text" size="10" maxlength="10" ng-model="event.date" iso-date id="date"></td>
      </tr>
      <tr ng-if="event.id">
	<th><label for="mtime">Letzte<br>Änderung</label></th>
	<td>
	  <input type="text" size="16" maxlength="19" ng-model="event.mtime" iso-timestamp id="mtime" disabled="disabled">
	</td>
      </tr>
      <tr>
	<th><label for="type">Art</label></th>
	<td>
	  <select ng-model="event.type" id="type" ng-click="type_blur()" ng-blur="type_blur()" nullable>
	    <option value=""></option>
	    <option value="otsv2016">ÖTSV</option>
	    <option value="otsv+osk2016">ÖTSV + AMF</option>
	    <option value="otsv-bike2015">ÖTSV Fahrrad</option>
	    <option value="otsv-ecup2015">ÖTSV Kids e-Cup (bis 2016)</option>
	    <option value="otsv2014">ÖTSV (bis 2015)</option>
	    <option value="otsv+osk2014">ÖTSV + OSK (bis 2015)</option>
	    <option value="otsv-ecup2017">ÖTSV Kids e-Cup</option>
	  </select>
      </tr>
      <tr>
	<th>Aktiv</th>
	<td>
	  <input type="checkbox" ng-model="event.enabled" id="enabled"><label for="enabled">Veranstaltung anzeigen und in Wertungen berücksichtigen</label>
	</td>
      </tr>
    </table>
  </fieldset><br>
  <fieldset style="display:inline">
    <legend>Wertungen</legend>
    <p>
      <label for="marks_skipped_zone">Für das Auslassen einer Sektion gibt es <input type="text" numeric size="2" maxlength="3" min="0" max="999" ng-model="event.marks_skipped_zone" id="marks_skipped_zone" style="text-align: center"> Punkte.</label>
    </p>
    <p>
      <input type="checkbox" ng-model="event.four_marks" id="four_marks"><label for="four_marks">Es gilt die Vierpunktewertung (Fahrradtrial).</label>
    </p>
    <p>
      <label for="equal_marks_resolution">Bei Gleichstand zählt das Rundenergebnis
      <select name="equal_marks_resolution" ng-model="event.equal_marks_resolution" numeric>
	<option value="0">nicht</option>
	<option value="1">der ersten besseren Runde</option>
	<option value="2">der letzten besseren Runde</option>
      </select>.</label>
    </p>
    <span ng-repeat="ranking in event.rankings track by $index">
      <fieldset style="display:inline">
	<legend>Wertung {{$index + 1}}</legend>
	<table>
	  <tr>
	    <th><label for="ranking{{$index + 1}}_title">Titel</label></th>
	    <td>
	      <input type="text" size="40" maxlength="70" ng-model="ranking.title" id="ranking{{$index + 1}}_title" nullable>
	    </td>
	  </tr>
	  <tr>
	    <th><label for="ranking{{$index + 1}}_subtitle">Subtitel</label></th>
	    <td>
	      <input type="text" size="40" maxlength="70" ng-model="ranking.subtitle" id="ranking{{$index + 1}}_subtitle" nullable>
	    </td>
	  </tr>
	  <tr>
	    <th><label for="ranking{{$index + 1}}_name">Bezeichnung</label></th>
	    <td>
	      <input type="text" size="20" maxlength="20" ng-model="ranking.name" id="ranking{{$index + 1}}_name" nullable>
	    </td>
	  </tr>
	</table>
      </fieldset><br>
    </span>
    <fieldset style="display:inline">
      <legend>Wertungspunkte</legend>
      <table>
	<tr>
	  <th>Rang</th>
	  <th>Punkte</th>
	<tr ng-repeat="punkte in event.scores track by $index">
	  <th>
	    <span title="{{$last ? 'Ab dem ' : ''}}{{$index + 1}}. Platz">{{$index + 1}}{{$last ? '+' : ''}}</span>
	  </th>
	  <td>
	    <input type="text" numeric size="2" maxlength="3" min="0" max="999" ng-model="event.scores[$index]" style="text-align: center">
	  </td>
	</tr>
      </table>
      <p>
	<input type="checkbox" ng-model="event.score_234" id="score_234"><label for="score_234">Wertungspunkte auch in den Wertungen 2, 3, und 4 vergeben.</label>
      </p>
      <p>
	<input type="checkbox" ng-model="event.split_score" id="split_score"><label for="split_score">Punkteteilung bei gleicher Platzierung.</label>
      </p>
    </fieldset>
  </fieldset><br>
  <fieldset style="display:inline">
    <legend>Klassen</legend>
    <!--
    <p>
      <input type="checkbox" name="classes_identical" id="classes_identical"><label for="classes_identical">Alle Klassen haben die gleiche Rundenanzahl, Fahrzeit, und befahren die gleichen Sektionen.</label>
    </p>
    -->
    <table>
      <tr>
	<th>Klasse</th>
	<th style="text-align:center">Bezeichnung</th>
	<th style="text-align:center">Spurfarbe</th>
	<th style="text-align:center">Runden</th>
	<th style="text-align:center">Fahrzeit</th>
	<th style="text-align:center">Wertung<br>in Klasse</th>
	<th style="text-align:center">Keine<br>Wertung&nbsp;1</th>
	<th style="text-align:center">Außer<br>Konkurrenz</th>
      </tr>
      <tr ng-repeat="class_ in event.classes track by $index">
	<th>{{$index + 1}}</th>
	<td style="text-align:center">
	  <input type="text" size="30" maxlengh="60" ng-model="class_.name">
	</td>
	<td style="text-align:center">
	  <!-- FIXME: Wenn leeres Feld eingegeben wird, wird Wert auf "" statt auf null gesetzt. -->
	  <select ng-model="event.classes[class_active[$index + 1] ? $index : class_.ranking_class - 1].color" id="class{{$index + 1}}_color" ng-disabled="!class_active[$index + 1]">
	    <option value=""></option>
	    <option value="#0000ff">Blau</option>
	    <option value="#ff0000">Rot</option>
	    <option value="#ffff00">Gelb</option>
	    <option value="#ffffff">Weiß</option>
	    <option value="#008000">Grün</option>
	    <option value="#a52a2a">Braun</option>
	    <!-- Weitere HTML-Farbcodes (z.B. #f660ab für Pink) hier anhängen. -->
	  </select>
	</td>
	<td style="text-align:center">
	  <input type="text" numeric size="1" maxlength="1" min="1" max="5" ng-model="event.classes[class_active[$index + 1] ? $index : class_.ranking_class - 1].rounds" style="text-align: center" ng-disabled="!class_active[$index + 1]">
	</td>
	<td style="text-align:center">
	  <!-- FIXME: Wenn leeres Feld eingegeben wird, wird Wert auf "" statt auf null gesetzt. -->
	  <input type="text" size="5" maxlength="8" ng-model="event.classes[class_active[$index + 1] ? $index : class_.ranking_class - 1].riding_time" iso-time style="text-align: center" ng-disabled="!class_active[$index + 1]">
	</td>
	<td style="text-align:center">
	  <input type="text" numeric size="2" maxlength="2" min="1" max="15" ranking-class="{{$index + 1}}" ng-model="class_.ranking_class" ng-blur="blur_ranking_class($index + 1, $event)" style="text-align: center">
	</td>
	<td style="text-align:center">
	  <input type="checkbox" ng-model="class_.no_ranking1">
	</td>
	<td style="text-align:center">
	  <input type="checkbox" ng-model="class_.non_competing">
	</td>
      </tr>
    </table>
  </fieldset><br>
  <fieldset style="display:inline">
    <legend>Befahrene Sektionen</legend>
    <table>
      <tr>
	<th>Klasse</th>
	<th ng-repeat="zone in zones_list track by $index" style="text-align:center"><span title="Sektion {{zone}}">{{zone}}</span></th>
      </tr>
      <tr ng-repeat="class_ in event.classes track by $index" ng-init="k = $index + 1">
	<th>{{k}}</th>
	<td ng-repeat="zone in zones_list track by $index" style="text-align:center;padding:0.35em">
	  <input type="checkbox" ng-model="zones[class_.ranking_class - 1][$index]" title="Sektion {{zone}}" ng-disabled="!class_active[k]">
	</td>
      </tr>
    </table>
  </fieldset><br>
  <fieldset style="display:inline">
    <legend>Kartenfarben</legend>
    <table>
      <tr ng-repeat="round in [1, 2, 3, 4, 5]">
	<th>Runde {{round}}</th>
	<td>
	  <select ng-model="event.card_colors[$index]">
	    <option value=""></option>
	    <option value="#0000ff">Blau</option>
	    <option value="#ff0000">Rot</option>
	    <option value="#ffff00">Gelb</option>
	    <option value="#ffffff">Weiß</option>
	    <option value="#008000">Grün</option>
	    <option value="#a52a2a">Braun</option>
	    <!-- Weitere HTML-Farbcodes (z.B. #f660ab für Pink) hier anhängen. -->
	  </select>
	</td>
      </tr>
    </table>
  </fieldset><br>
  <fieldset style="display:inline">
    <legend>Fahrer und Gruppen</legend>
    <fieldset style="display:inline">
      <legend>Sichtbare Felder</legend>
	<p>
	  <input type="checkbox" ng-model="features.number" id="feature_nummer"><label for="feature_nummer">Startnummer</label><br>
	  <input type="checkbox" ng-model="features['class']" id="feature_class" disabled="disabled"><label for="feature_class">Klasse</label><br>
	  <input type="checkbox" ng-model="features.last_name" id="feature_last_name" disabled="disabled"><label for="feature_last_name">Nachname</label><br>
	  <input type="checkbox" ng-model="features.first_name" id="feature_first_name" disabled="disabled"><label for="feature_first_name">Vorname</label><br>
	  <input type="checkbox" ng-model="features.ranking1" id="feature_ranking1"><label for="feature_ranking1">Wertung 1</label><br>
	  <input type="checkbox" ng-model="features.registered" id="feature_registered"><label for="feature_registered">Nennungseingang</label><br>
	  <input type="checkbox" ng-model="features.start" id="feature_start" disabled="disabled"><label for="feature_start">Start</label><br>
	  <input type="checkbox" ng-model="features.guardian" id="feature_guardian"><label for="feature_guardian">Gesetzlicher Vertreter</label><br>
	  <input type="checkbox" ng-model="features.minder" id="feature_minder"><label for="feature_minder">Minder</label>
	</p>

	<p>
	  <input type="checkbox" ng-model="features.registration" id="feature_registration"><label for="feature_registration">Pol. Kennzeichen</label><br>
	  <input type="checkbox" ng-model="features.country" id="feature_country"><label for="feature_country">Staatsangehörigkeit</label><br>
	  <input type="checkbox" ng-model="features.frame_number" id="feature_frame_number"><label for="feature_frame_number">Rahmennummer</label><br>
	  <input type="checkbox" ng-model="features.license" id="feature_license"><label for="feature_license">Lizenznummer</label><br>
	  <input type="checkbox" ng-model="features.displacement" id="feature_displacement"><label for="feature_displacement">Hubraum</label><br>
	  <input type="checkbox" ng-model="features.email" id="feature_email"><label for="feature_email">E-Mail</label><br>
	  <input type="checkbox" ng-model="features.comment" id="feature_comment"><label for="feature_comment">Bemerkungen</label><br>
	  <input type="checkbox" ng-model="features.rider_comment" id="feature_rider_comment"><label for="feature_rider_comment">Anmerkungen und Wünsche</label><br>
	  <input type="checkbox" ng-model="features.street" id="feature_street"><label for="feature_street">Straße</label><br>
	  <input type="checkbox" ng-model="features.zip" id="feature_zip"><label for="feature_zip">Postleitzahl</label><br>
	  <input type="checkbox" ng-model="features.city" id="feature_city"><label for="feature_city">Wohnort</label><br>
	  <input type="checkbox" ng-model="features.phone" id="feature_phone"><label for="feature_phone">Telefon</label><br>
	  <input type="checkbox" ng-model="features.emergency_phone" id="feature_emergency_phone"><label for="feature_emergency_phone">Notfall-Telefon</label><br>
	  <input type="checkbox" ng-model="features.date_of_birth" id="feature_date_of_birth"><label for="feature_date_of_birth">Geburtsdatum</label><br>
	  <input type="checkbox" ng-model="features.applicant" id="feature_applicant"><label for="feature_applicant">Bewerber</label><br>
	  <input type="checkbox" ng-model="features.club" id="feature_club"><label for="feature_club">Club</label><br>
	  <input type="checkbox" ng-model="features.vehicle" id="feature_vehicle"><label for="feature_vehicle">Fahrzeug</label><br>
	  <input type="checkbox" ng-model="features.start_time" id="feature_start_time"><label for="feature_start_time">Startzeit</label><br>
	  <input type="checkbox" ng-model="features.finish_time" id="feature_finish_time"><label for="feature_finish_time">Zielzeit</label><br>
	  <input type="checkbox" ng-model="features.ranking2" id="feature_ranking2"><label for="feature_ranking2">Wertung 2</label><br>
	  <input type="checkbox" ng-model="features.ranking3" id="feature_ranking3"><label for="feature_ranking3">Wertung 3</label><br>
	  <input type="checkbox" ng-model="features.ranking4" id="feature_ranking4"><label for="feature_ranking4">Wertung 4</label><br>
	  <input type="checkbox" ng-model="features.entry_fee" id="feature_entry_fee"><label for="feature_entry_fee">Nenngeld</label><br>
	  <input type="checkbox" ng-model="features.insurance" id="feature_insurance"><label for="feature_insurance">Versicherung</label>
	</p>
	<p>
	  <input type="checkbox" ng-model="features.province" id="feature_province"><label for="feature_province">Bundesland</label>
	</p>
    </fieldset><br>
    <fieldset style="display:inline">
      <legend>Voreinstellungen für neue Fahrer</legend>
      <p>
	<input type="checkbox" ng-model="event.ranking1_enabled" id="ranking1_enabled"><label for="ranking1_enabled">Der Fahrer nimmt an Wertung 1 teil.</label>
      </p>
      <p>
	<label for="insurance">Die Versicherungsart ist
	<select ng-model="event.insurance" id="insurance" numeric>
	  <option value="0"></option>
	  <option value="1">ADAC-Versicherung</option>
	  <option value="2">DMV-Versicherung</option>
	  <option value="3">KFZ-Versicherung</option>
	  <option value="4">Tagesversicherung</option>
	</select>.</label>
      </p>
    </fieldset>
  </fieldset><br>
  <fieldset style="display:inline">
    <legend>Fahrerliste und Auswertung</legend>
    <table>
      <tr>
        <th><label for="class_order">Klassenreihenfolge</label></th>
	<td>
	  <input type="text" size="20" maxlength="40" ng-pattern="/^[\d\s]*$/" ng-model="event.class_order">
	</td>
      </tr>
    </table>
    <fieldset style="display:inline">
      <legend>Auswertung</legend>
	<p>
	  <input type="checkbox" ng-model="features.individual_points" id="feature_einzelpunkte"><label for="feature_einzelpunkte">Einzelpunkte statt Punkteverteilung</label><br>
	  <input type="checkbox" ng-model="features.column_5" id="feature_spalte5er"><label for="feature_spalte5er">Spalte für Fünfer in Punkteverteilung</label><br>
	</p>
    </fieldset>
  </fieldset><br>
  <fieldset style="display:inline">
    <legend>Startzeiten zufällig vergeben</legend>
    <table>
      <tr>
	<th><label for="start_time">Startzeit</label></th>
	<td>
	  <input type="text" size="6" maxlength="8" ng-model="event.start_time" id="start_time" iso-time>
	</td>
      </tr>
      <tr>
	<th><label for="start_interval">Startintervall</label></th>
	<td>
	  <input type="text" numeric min="1" max="600" size="3" ng-model="event.start_interval" id="start_interval"> Sekunden
	</td>
      </tr>
      <tr>
	<th><label for="start_spec">Klassen</label></th>
	<td>
	  <input type="text" size="20" maxlength="40" ng-model="event.start_spec" id="start_spec">
	</td>
      </tr>
    </table>
  </fieldset><br>
  <fieldset style="display:inline">
    <legend>Zukünftige Veranstaltungen</legend>
    <table>
      <tr>
	<th style="text-align:center">Aktiv</th>
        <th style="text-align:center">Datum</th>
	<th style="text-align:center">Titel</th>
	<th style="text-align:center">Veranstaltungsreihen</th>
      </tr>
      <tr ng-repeat="future_event in event.future_events">
	<td style="text-align:center">
	  <input type="checkbox" ng-model="future_event.active">
	</td>
	<td>
	  <input type="text" size="8" maxlength="10" ng-model="future_event.date" iso-date id="date" ng-model-options="{ updateOn: 'blur'}">
	</td>
	<td>
	  <input type="text" size="30" maxlength="40" ng-model="future_event.title" nullable>
	</td>
	<td>
	  <input type="text" size="30" maxlength="40" ng-model="future_event.series" nullable>
	</td>
      </tr>
    </table>
  </fieldset><br>
  <fieldset style="display:inline">
    <legend>Registrierung</legend>
    <table>
      <tr>
	<th><label for="registration_info">Allgemeine Informationen<br>(HTML)</label></th>
	<td>
	  <textarea rows="5" cols="70" maxlength="512" nullable ng-model="event.registration_info" id="registration_info"></textarea>
	</td>
      </tr>
      <tr>
	<th><label for="registration_ends">Ende der Registrierung</label></th>
	<td>
	  <input type="text" size="16" maxlength="19" ng-model="event.registration_ends" iso-timestamp id="registration_ends">
	</td>
      </tr>
      <tr>
	<th><label for="registration_email">Benachrichtigungs-E-Mail</label></th>
	<td>
	  <input type="text" size="40" maxlength="60" ng-model="event.registration_email" id="registration_email" nullable>
	</td>
      </tr>
    </table>
  </fieldset>
  <p>
    <button type="button" ng-disabled="!(modified() && form.$valid) || busy" ng-click="save()">Speichern</button>
    <button type="button" ng-disabled="!modified() || busy" ng-click="discard()" tabindex="-1">Verwerfen</button>
  </p>
</form>
